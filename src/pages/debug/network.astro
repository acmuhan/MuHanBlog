---
import Layout from "@layouts/Layout.astro";
---

<Layout title="ç½‘ç»œè°ƒè¯•å·¥å…· - MuHan's Blog">
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-90 mb-4">ğŸ”§ ç½‘ç»œè°ƒè¯•å·¥å…·</h1>
        <p class="text-60">æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒç½‘ç»œç­–ç•¥å’Œå¤–éƒ¨HTTPæœåŠ¡è®¿é—®èƒ½åŠ›</p>
      </div>

      <!-- ç¯å¢ƒä¿¡æ¯ -->
      <div class="card-base p-6 mb-6">
        <h2 class="text-xl font-semibold text-90 mb-4">ğŸ“Š ç¯å¢ƒä¿¡æ¯</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <strong class="text-70">å½“å‰åŸŸå:</strong>
            <span id="current-domain" class="text-60">æ£€æµ‹ä¸­...</span>
          </div>
          <div>
            <strong class="text-70">åè®®:</strong>
            <span id="current-protocol" class="text-60">æ£€æµ‹ä¸­...</span>
          </div>
          <div>
            <strong class="text-70">ç”¨æˆ·ä»£ç†:</strong>
            <span id="user-agent" class="text-60 text-sm">æ£€æµ‹ä¸­...</span>
          </div>
          <div>
            <strong class="text-70">æ—¶é—´æˆ³:</strong>
            <span id="timestamp" class="text-60">æ£€æµ‹ä¸­...</span>
          </div>
        </div>
      </div>

      <!-- ç½‘ç»œè¿é€šæ€§æµ‹è¯• -->
      <div class="card-base p-6 mb-6">
        <h2 class="text-xl font-semibold text-90 mb-4">ğŸŒ ç½‘ç»œè¿é€šæ€§æµ‹è¯•</h2>
        
        <!-- æµ‹è¯•æ§åˆ¶ -->
        <div class="mb-6">
          <button id="start-test" class="btn-primary mr-4">å¼€å§‹æµ‹è¯•</button>
          <button id="clear-results" class="btn-secondary">æ¸…é™¤ç»“æœ</button>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div id="test-results" class="space-y-4">
          <!-- æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
      </div>

      <!-- éŸ³ä¹APIä¸“é¡¹æµ‹è¯• -->
      <div class="card-base p-6 mb-6">
        <h2 class="text-xl font-semibold text-90 mb-4">ğŸµ éŸ³ä¹APIä¸“é¡¹æµ‹è¯•</h2>
        
        <div class="mb-4">
          <button id="test-music-api" class="btn-primary">æµ‹è¯•éŸ³ä¹API</button>
        </div>

        <div id="music-api-results" class="space-y-4">
          <!-- éŸ³ä¹APIæµ‹è¯•ç»“æœ -->
        </div>
      </div>

      <!-- ä»£ç†APIæµ‹è¯• -->
      <div class="card-base p-6 mb-6">
        <h2 class="text-xl font-semibold text-90 mb-4">ğŸ”„ ä»£ç†APIæµ‹è¯•</h2>
        
        <div class="mb-4">
          <button id="test-proxy-api" class="btn-primary">æµ‹è¯•ä»£ç†API</button>
        </div>

        <div id="proxy-api-results" class="space-y-4">
          <!-- ä»£ç†APIæµ‹è¯•ç»“æœ -->
        </div>
      </div>

      <!-- è¯¦ç»†æ—¥å¿— -->
      <div class="card-base p-6">
        <h2 class="text-xl font-semibold text-90 mb-4">ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
        <div class="mb-4">
          <button id="clear-logs" class="btn-secondary">æ¸…é™¤æ—¥å¿—</button>
        </div>
        <pre id="debug-logs" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg text-sm overflow-auto max-h-96 text-60"></pre>
      </div>
    </div>
  </main>
</Layout>

<script>
  // å…¨å±€å˜é‡
  let testResults: any[] = [];
  let debugLogs: string[] = [];

  // DOMå…ƒç´ 
  const startTestBtn = document.getElementById('start-test');
  const clearResultsBtn = document.getElementById('clear-results');
  const testMusicApiBtn = document.getElementById('test-music-api');
  const testProxyApiBtn = document.getElementById('test-proxy-api');
  const clearLogsBtn = document.getElementById('clear-logs');
  
  const testResultsEl = document.getElementById('test-results');
  const musicApiResultsEl = document.getElementById('music-api-results');
  const proxyApiResultsEl = document.getElementById('proxy-api-results');
  const debugLogsEl = document.getElementById('debug-logs');

  // åˆå§‹åŒ–é¡µé¢
  function initializePage() {
    // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
    document.getElementById('current-domain')!.textContent = window.location.hostname;
    document.getElementById('current-protocol')!.textContent = window.location.protocol;
    document.getElementById('user-agent')!.textContent = navigator.userAgent;
    document.getElementById('timestamp')!.textContent = new Date().toLocaleString();

    log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
  }

  // æ—¥å¿—å‡½æ•°
  function log(message: string, type: string = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
    debugLogs.push(logEntry);
    
    if (debugLogsEl) {
      debugLogsEl.textContent = debugLogs.join('\n');
      debugLogsEl.scrollTop = debugLogsEl.scrollHeight;
    }
    
    console.log(logEntry);
  }

  // åˆ›å»ºæµ‹è¯•ç»“æœå…ƒç´ 
  function createTestResult(title: string, status: string, details: string = '', error: string | null = null) {
    const resultEl = document.createElement('div');
    resultEl.className = `p-4 rounded-lg border ${
      status === 'success' ? 'bg-green-50 border-green-200 dark:bg-green-900/20 dark:border-green-800' :
      status === 'error' ? 'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800' :
      'bg-yellow-50 border-yellow-200 dark:bg-yellow-900/20 dark:border-yellow-800'
    }`;

    const statusIcon = status === 'success' ? 'âœ…' : status === 'error' ? 'âŒ' : 'âš ï¸';
    const statusColor = status === 'success' ? 'text-green-700 dark:text-green-300' :
                       status === 'error' ? 'text-red-700 dark:text-red-300' :
                       'text-yellow-700 dark:text-yellow-300';

    resultEl.innerHTML = `
      <div class="flex items-start gap-3">
        <span class="text-xl">${statusIcon}</span>
        <div class="flex-1">
          <h3 class="font-semibold ${statusColor}">${title}</h3>
          ${details ? `<p class="text-sm text-60 mt-1">${details}</p>` : ''}
          ${error ? `<pre class="text-xs text-red-600 dark:text-red-400 mt-2 bg-red-100 dark:bg-red-900/30 p-2 rounded">${error}</pre>` : ''}
        </div>
      </div>
    `;

    return resultEl;
  }

  // ç½‘ç»œè¿é€šæ€§æµ‹è¯•
  async function testNetworkConnectivity() {
    log('å¼€å§‹ç½‘ç»œè¿é€šæ€§æµ‹è¯•');
         testResultsEl!.innerHTML = '<div class="text-center text-60">æµ‹è¯•è¿›è¡Œä¸­...</div>';

     const tests = [
      {
        name: 'æœ¬åœ°APIæµ‹è¯•',
        url: '/api/network-test?test=local',
        description: 'æµ‹è¯•æœ¬åœ°APIå“åº”'
      },
      {
        name: 'å…¬å…±APIæµ‹è¯• (HTTPS)',
        url: 'https://httpbin.org/get',
        description: 'æµ‹è¯•HTTPSå¤–éƒ¨APIè®¿é—®'
      },
      {
        name: 'éŸ³ä¹APIæµ‹è¯• (HTTP)',
        url: 'http://111.170.19.241:8002/playlist?playlist_id=12291029891&page=1&page_size=5',
        description: 'ç›´æ¥æµ‹è¯•éŸ³ä¹API HTTPç«¯ç‚¹'
      },
      {
        name: 'éŸ³ä¹APIæµ‹è¯• (HTTPS)',
        url: 'https://111.170.19.241:8002/playlist?playlist_id=12291029891&page=1&page_size=5',
        description: 'ç›´æ¥æµ‹è¯•éŸ³ä¹API HTTPSç«¯ç‚¹'
      }
    ];

     const results = [];
     testResultsEl!.innerHTML = '';

     for (const test of tests) {
      log(`æµ‹è¯•: ${test.name} - ${test.url}`);
      
      try {
        const startTime = Date.now();
        const response = await fetch(test.url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶
        });
        
        const endTime = Date.now();
        const duration = endTime - startTime;

        if (response.ok) {
          const contentType = response.headers.get('content-type');
          let responseData = '';
          
          try {
            if (contentType && contentType.includes('application/json')) {
              const json = await response.json();
              responseData = JSON.stringify(json, null, 2).substring(0, 200) + '...';
            } else {
              responseData = await response.text().then(text => text.substring(0, 200) + '...');
            }
          } catch (e) {
            responseData = 'æ— æ³•è§£æå“åº”å†…å®¹';
          }

          const result = createTestResult(
            test.name,
            'success',
            `${test.description} - å“åº”æ—¶é—´: ${duration}ms - çŠ¶æ€: ${response.status}`,
            responseData
          );
           testResultsEl!.appendChild(result);
           log(`âœ… ${test.name} æˆåŠŸ - ${duration}ms`, 'success');
         } else {
           const result = createTestResult(
             test.name,
             'error',
             `${test.description} - HTTP ${response.status}: ${response.statusText}`,
             null
           );
           testResultsEl!.appendChild(result);
          log(`âŒ ${test.name} å¤±è´¥ - HTTP ${response.status}`, 'error');
        }
       } catch (error) {
         const errorMessage = error instanceof Error ? error.message : String(error);
         const result = createTestResult(
           test.name,
           'error',
           `${test.description} - è¿æ¥å¤±è´¥`,
           errorMessage
         );
         testResultsEl!.appendChild(result);
         log(`âŒ ${test.name} é”™è¯¯: ${errorMessage}`, 'error');
      }
    }

    log('ç½‘ç»œè¿é€šæ€§æµ‹è¯•å®Œæˆ');
  }

   // éŸ³ä¹APIä¸“é¡¹æµ‹è¯•
   async function testMusicAPI() {
     log('å¼€å§‹éŸ³ä¹APIä¸“é¡¹æµ‹è¯•');
     musicApiResultsEl!.innerHTML = '<div class="text-center text-60">æµ‹è¯•è¿›è¡Œä¸­...</div>';

     const endpoints = [
       'http://111.170.19.241:8002',
       'https://111.170.19.241:8002',
       'http://111.170.19.241:8002/playlist?playlist_id=12291029891&page=1&page_size=5'
     ];

     musicApiResultsEl!.innerHTML = '';

    for (const endpoint of endpoints) {
      try {
        log(`æµ‹è¯•éŸ³ä¹APIç«¯ç‚¹: ${endpoint}`);
        
        const response = await fetch(endpoint, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          signal: AbortSignal.timeout(8000)
        });

        if (response.ok) {
          const data = await response.json();
          const result = createTestResult(
            `éŸ³ä¹API: ${endpoint}`,
            'success',
            `æˆåŠŸè·å–æ•°æ® - çŠ¶æ€: ${response.status}`,
            JSON.stringify(data, null, 2).substring(0, 300) + '...'
          );
           musicApiResultsEl!.appendChild(result);
           log(`âœ… éŸ³ä¹API ${endpoint} æˆåŠŸ`, 'success');
         } else {
           const result = createTestResult(
             `éŸ³ä¹API: ${endpoint}`,
             'error',
             `HTTP ${response.status}: ${response.statusText}`,
             null
           );
           musicApiResultsEl!.appendChild(result);
          log(`âŒ éŸ³ä¹API ${endpoint} å¤±è´¥ - HTTP ${response.status}`, 'error');
        }
       } catch (error) {
         const errorMessage = error instanceof Error ? error.message : String(error);
         const result = createTestResult(
           `éŸ³ä¹API: ${endpoint}`,
           'error',
           'è¿æ¥å¤±è´¥',
           errorMessage
         );
         musicApiResultsEl!.appendChild(result);
         log(`âŒ éŸ³ä¹API ${endpoint} é”™è¯¯: ${errorMessage}`, 'error');
      }
    }

    log('éŸ³ä¹APIä¸“é¡¹æµ‹è¯•å®Œæˆ');
  }

   // ä»£ç†APIæµ‹è¯•
   async function testProxyAPI() {
     log('å¼€å§‹ä»£ç†APIæµ‹è¯•');
     proxyApiResultsEl!.innerHTML = '<div class="text-center text-60">æµ‹è¯•è¿›è¡Œä¸­...</div>';

     const tests = [
       {
         name: 'éŸ³ä¹ä»£ç†API',
         url: '/api/music-proxy?playlist_id=12291029891&page=1&page_size=5'
       },
       {
         name: 'ç½‘ç»œæµ‹è¯•API',
         url: '/api/network-test?test=proxy'
       }
     ];

     proxyApiResultsEl!.innerHTML = '';

    for (const test of tests) {
      try {
        log(`æµ‹è¯•ä»£ç†API: ${test.name} - ${test.url}`);
        
        const response = await fetch(test.url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          signal: AbortSignal.timeout(10000)
        });

        if (response.ok) {
          const data = await response.json();
          const result = createTestResult(
            test.name,
            'success',
            `ä»£ç†APIå“åº”æˆåŠŸ - çŠ¶æ€: ${response.status}`,
            JSON.stringify(data, null, 2).substring(0, 300) + '...'
          );
           proxyApiResultsEl!.appendChild(result);
           log(`âœ… ${test.name} æˆåŠŸ`, 'success');
         } else {
           const result = createTestResult(
             test.name,
             'error',
             `HTTP ${response.status}: ${response.statusText}`,
             null
           );
           proxyApiResultsEl!.appendChild(result);
          log(`âŒ ${test.name} å¤±è´¥ - HTTP ${response.status}`, 'error');
        }
       } catch (error) {
         const errorMessage = error instanceof Error ? error.message : String(error);
         const result = createTestResult(
           test.name,
           'error',
           'ä»£ç†APIè¯·æ±‚å¤±è´¥',
           errorMessage
         );
         proxyApiResultsEl!.appendChild(result);
         log(`âŒ ${test.name} é”™è¯¯: ${errorMessage}`, 'error');
      }
    }

    log('ä»£ç†APIæµ‹è¯•å®Œæˆ');
  }

  // äº‹ä»¶ç›‘å¬å™¨
  startTestBtn?.addEventListener('click', testNetworkConnectivity);
  testMusicApiBtn?.addEventListener('click', testMusicAPI);
  testProxyApiBtn?.addEventListener('click', testProxyAPI);
  
   clearResultsBtn?.addEventListener('click', () => {
     testResultsEl!.innerHTML = '';
     musicApiResultsEl!.innerHTML = '';
     proxyApiResultsEl!.innerHTML = '';
     log('æµ‹è¯•ç»“æœå·²æ¸…é™¤');
   });

   clearLogsBtn?.addEventListener('click', () => {
     debugLogs = [];
     debugLogsEl!.textContent = '';
     log('æ—¥å¿—å·²æ¸…é™¤');
   });

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', initializePage);
</script>

<style>
  .btn-primary {
    @apply bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors;
  }
  
  .btn-secondary {
    @apply bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:opacity-90 transition-opacity;
  }
  
  .card-base {
    @apply bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700;
  }
</style>

