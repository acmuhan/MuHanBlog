---
import { siteConfig } from "../config";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

// æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†Giscusè¯„è®ºç³»ç»Ÿ
const giscusConfig = siteConfig.comment?.giscus;
const isGiscusEnabled =
	giscusConfig?.repo && giscusConfig?.repoId && giscusConfig?.categoryId;
---

{isGiscusEnabled && (
	<div class:list={["giscus-container", className]} style={style}>
		<div class="giscus-wrapper">
			<!-- Giscusè¯„è®ºåŒºåŸŸ -->
			<div class="giscus"></div>
		</div>
		
		<!-- Giscusè„šæœ¬ -->
		<script 
			src="https://giscus.app/client.js"
			data-repo={giscusConfig.repo}
			data-repo-id={giscusConfig.repoId}
			data-category={giscusConfig.category}
			data-category-id={giscusConfig.categoryId}
			data-mapping={giscusConfig.mapping || "pathname"}
			data-strict={giscusConfig.strict ? "1" : "0"}
			data-reactions-enabled={giscusConfig.reactionsEnabled ? "1" : "0"}
			data-emit-metadata={giscusConfig.emitMetadata ? "1" : "0"}
			data-input-position={giscusConfig.inputPosition || "bottom"}
			data-theme={giscusConfig.theme || "preferred_color_scheme"}
			data-lang={giscusConfig.lang || "zh-CN"}
			data-loading={giscusConfig.loading || "lazy"}
			crossorigin="anonymous"
			async>
		</script>

		<!-- ä¸»é¢˜åˆ‡æ¢æ”¯æŒè„šæœ¬ -->
		<script is:inline>
			// ç›‘å¬ä¸»é¢˜å˜åŒ–ï¼ŒåŠ¨æ€æ›´æ–°Giscusä¸»é¢˜
			function updateGiscusTheme() {
				const giscusFrame = document.querySelector('iframe.giscus-frame');
				if (giscusFrame) {
					const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
					const theme = isDark ? 'dark' : 'light';
					
					// å‘é€ä¸»é¢˜æ›´æ–°æ¶ˆæ¯åˆ°Giscus iframe
					giscusFrame.contentWindow?.postMessage(
						{ giscus: { setConfig: { theme } } },
						'https://giscus.app'
					);
				}
			}

			// ç›‘å¬ä¸»é¢˜å˜åŒ–
			const observer = new MutationObserver((mutations) => {
				mutations.forEach((mutation) => {
					if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
						updateGiscusTheme();
					}
				});
			});

			// å¼€å§‹è§‚å¯Ÿä¸»é¢˜å˜åŒ–
			observer.observe(document.documentElement, {
				attributes: true,
				attributeFilter: ['data-theme']
			});

			// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ä¸»é¢˜
			document.addEventListener('DOMContentLoaded', () => {
				setTimeout(updateGiscusTheme, 1000);
			});
		</script>
	</div>
)}

{!isGiscusEnabled && (
	<div class:list={["comment-placeholder", className]} style={style}>
		<div class="text-center py-8 text-black/50 dark:text-white/50">
			<p class="mb-2">ğŸ’¬ è¯„è®ºç³»ç»Ÿæœªé…ç½®</p>
			<p class="text-sm">è¯·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®Giscuså‚æ•°ä»¥å¯ç”¨è¯„è®ºåŠŸèƒ½</p>
		</div>
	</div>
)}

<style>
	.giscus-container {
		@apply w-full mt-8 mb-4;
	}

	.giscus-wrapper {
		@apply rounded-xl overflow-hidden;
		background: var(--card-bg);
		border: 1px solid var(--line-divider);
	}

	.comment-placeholder {
		@apply w-full mt-8 mb-4 rounded-xl;
		background: var(--card-bg);
		border: 1px solid var(--line-divider);
	}

	/* Giscusæ ·å¼è°ƒæ•´ */
	:global(.giscus) {
		@apply w-full;
	}

	:global(.giscus-frame) {
		@apply w-full border-0;
		min-height: 200px;
	}

	/* å“åº”å¼è®¾è®¡ */
	@media (max-width: 768px) {
		.giscus-container {
			@apply mx-0;
		}
	}

	/* æ·±è‰²æ¨¡å¼é€‚é… */
	:global([data-theme="dark"]) .giscus-wrapper {
		border-color: rgba(255, 255, 255, 0.1);
	}

	:global([data-theme="light"]) .giscus-wrapper {
		border-color: rgba(0, 0, 0, 0.1);
	}
</style>
